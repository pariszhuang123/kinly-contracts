---
Domain: Shared
Capability: Preference Reports
Scope: shared
Artifact-Type: contract
Stability: evolving
Status: draft
Version: v1.0
---

# Kinly Preference Report Contract v1

Status: Draft for MVP (home-only)

Scope: Personal preference report generation, sharing, and subject edits.

Audience: Product, design, engineering, AI agents.

Depends on:
- Preference Taxonomy v1
- Preference Scenarios v1
- Home Dynamics Contract v1

1. Purpose

Define how Kinly generates a readable, non-enforceable preference report that
helps members learn about each other. This report is derived from scenario
responses and can be optionally edited by the subject to clarify or soften
language without changing the underlying preference selections.

2. Core Principles
- Reports are descriptive summaries, not rules.
- Reports do not gate actions or permissions.
- The report is derived from a template and can be refined by subject edits.
- Edits must preserve meaning and remain non-enforceable.
- Underlying preference selections remain unchanged by edits.
- Other members may acknowledge a report but cannot respond with demands or
  corrective feedback.

3. Report Lifecycle

3.1 Template -> Published
- Template: keyed text frames grouped by preference domain and locale.
- Generated report is published immediately for the subject.
- Published reports are visible to other members (and the subject).
Generated and published content are stored separately to support diffs, audits,
and safe regeneration.

3.2 Regeneration rules
- Regenerate when the subject explicitly requests it.
- Do not auto-overwrite subject edits on a published report.
- If inputs change, mark the report as "out_of_date". The subject can choose
  to regenerate. Once any section is edited, template updates never apply unless
  the subject explicitly regenerates.

4. Report Structure

Each report contains:
- A summary object with title + subtitle.
- Domain sections (environment, schedule, communication, cleanliness, privacy,
  social, routine, conflict).
- Safe phrasing constraints (no instructions, no blame, no enforcement language).

Reports are section-based so edits can be scoped. Content is stored as structured
JSON with a summary plus per-domain sections (not separate columns). Sections
are arrays of objects with `section_key` and `text` (optional metadata allowed).
Section text is generated by concatenating the resolved preference texts for the
matching domain. Template section text is a fallback when no resolved text is
available.

4.1 Template copy seed (example)

Lint checks this block to ensure preference reports avoid enforcement language.

```preference-report-copy
Summary: I prefer a calm, clear rhythm at home.
Environment: I prefer quieter shared spaces and softer lighting.
Communication: I prefer quick check-ins when something needs coordinating.
```

4.2 Template JSON seed (example)

Lint checks this block to ensure each taxonomy ID has exactly three option
variants in the template.

```preference-report-template-json
{
  "template_key": "personal_preferences_v1",
  "locale": "en",
  "summary": {
    "title": "Personal preferences",
    "subtitle": "This helps housemates understand comfort styles. Not rules."
  },
  "preferences": {
    "environment_noise_tolerance": [
      { "value_key": "low", "title": "Low", "text": "I'm most comfortable when shared spaces are mostly quiet." },
      { "value_key": "medium", "title": "Medium", "text": "Some background noise is fine, especially at reasonable hours." },
      { "value_key": "high", "title": "High", "text": "I'm generally okay with lively noise in shared spaces." }
    ],
    "environment_light_preference": [
      { "value_key": "dim", "title": "Dim", "text": "I prefer softer lighting in shared spaces." },
      { "value_key": "balanced", "title": "Balanced", "text": "I'm comfortable with a mix of natural and indoor light." },
      { "value_key": "bright", "title": "Bright", "text": "I feel best with brighter lighting in shared areas." }
    ],
    "environment_scent_sensitivity": [
      { "value_key": "sensitive", "title": "Sensitive", "text": "Strong scents can bother me, so I prefer mild/no fragrance." },
      { "value_key": "neutral", "title": "Neutral", "text": "I'm okay with light scents in moderation." },
      { "value_key": "tolerant", "title": "Tolerant", "text": "Scent usually doesn't affect me much." }
    ],
    "schedule_quiet_hours_preference": [
      { "value_key": "early_evening", "title": "Early evening", "text": "I prefer things to wind down earlier in the evening." },
      { "value_key": "late_evening_or_night", "title": "Late evening", "text": "Later evenings are fine for me if people are mindful." },
      { "value_key": "none", "title": "No preference", "text": "I don't have a strong quiet-hours preference." }
    ],
    "schedule_sleep_timing": [
      { "value_key": "early", "title": "Early", "text": "I usually sleep and wake earlier." },
      { "value_key": "standard", "title": "Standard", "text": "My sleep timing is fairly typical." },
      { "value_key": "late", "title": "Late", "text": "I tend to sleep and wake later." }
    ],
    "communication_channel": [
      { "value_key": "text", "title": "Text", "text": "I prefer messages for quick coordination." },
      { "value_key": "call", "title": "Call", "text": "I prefer a quick call when something matters." },
      { "value_key": "in_person", "title": "In person", "text": "I prefer talking face-to-face when possible." }
    ],
    "communication_directness": [
      { "value_key": "gentle", "title": "Gentle", "text": "I prefer softer phrasing and good timing." },
      { "value_key": "balanced", "title": "Balanced", "text": "I'm okay with a mix of directness and tact." },
      { "value_key": "direct", "title": "Direct", "text": "I'm most comfortable being straightforward." }
    ],
    "cleanliness_shared_space_tolerance": [
      { "value_key": "low", "title": "Low", "text": "I prefer shared areas to stay consistently tidy." },
      { "value_key": "medium", "title": "Medium", "text": "A bit of clutter happens, but resets are important." },
      { "value_key": "high", "title": "High", "text": "I'm generally okay with some clutter in shared spaces." }
    ],
    "privacy_room_entry": [
      { "value_key": "always_ask", "title": "Always ask", "text": "Please ask/knock before entering my room." },
      { "value_key": "usually_ask", "title": "Usually ask", "text": "A knock is great; urgent things can be flexible." },
      { "value_key": "open_door", "title": "Open door", "text": "I'm generally okay with casual entry if respectful." }
    ],
    "privacy_notifications": [
      { "value_key": "none", "title": "None", "text": "I prefer not to receive messages after quiet hours." },
      { "value_key": "limited", "title": "Limited", "text": "Only important messages after quiet hours." },
      { "value_key": "ok", "title": "Ok", "text": "I'm generally okay with late messages." }
    ],
    "social_hosting_frequency": [
      { "value_key": "rare", "title": "Rare", "text": "I feel best with guests only now and then." },
      { "value_key": "sometimes", "title": "Sometimes", "text": "Sometimes is okay with a heads-up." },
      { "value_key": "often", "title": "Often", "text": "I'm comfortable with frequent guests." }
    ],
    "social_togetherness": [
      { "value_key": "mostly_solo", "title": "Mostly solo", "text": "I recharge best with more solo time at home." },
      { "value_key": "balanced", "title": "Balanced", "text": "I like a mix of solo time and shared moments." },
      { "value_key": "mostly_together", "title": "Mostly together", "text": "I enjoy a more social, shared home." }
    ],
    "routine_planning_style": [
      { "value_key": "planner", "title": "Planner", "text": "I like plans and clear expectations." },
      { "value_key": "mixed", "title": "Mixed", "text": "Some planning helps, but I stay flexible." },
      { "value_key": "spontaneous", "title": "Spontaneous", "text": "I prefer keeping it open and adapting." }
    ],
    "conflict_resolution_style": [
      { "value_key": "cool_off", "title": "Pause", "text": "A little space first helps me reset." },
      { "value_key": "talk_soon", "title": "Talk soon", "text": "Talking it through soon helps me feel okay." },
      { "value_key": "mediate", "title": "Gentle check-in", "text": "A kind check-in at the right time helps." }
    ]
  },
  "sections": [
    { "section_key": "environment", "title": "Environment", "text": "How you prefer the shared space to feel." },
    { "section_key": "schedule", "title": "Schedule", "text": "Timing preferences that affect comfort." },
    { "section_key": "communication", "title": "Communication", "text": "How you like to coordinate and give feedback." },
    { "section_key": "cleanliness", "title": "Cleanliness", "text": "What \"tidy enough\" means to you." },
    { "section_key": "privacy", "title": "Privacy", "text": "Boundaries that help you feel at ease." },
    { "section_key": "social", "title": "Social", "text": "Your comfort with guests and togetherness." },
    { "section_key": "routine", "title": "Routine", "text": "Planning vs spontaneity." },
    { "section_key": "conflict", "title": "Repair", "text": "What helps after small tension." }
  ]
}
```

5. Subject Edits

Who can edit:
- Subject only (the person who owns the preferences).

Edit constraints:
- Must not add enforceable language (rule-like phrasing).
- Must not include personal data beyond the preference responses.
- Must keep first-person preference framing ("I prefer...").
- Edits update section text only; titles remain template-defined.

Edit tracking:
- Store edits as revisions with timestamps and editor id.
- Maintain original generated content for comparison.
- Allow reverting to the latest generated draft.

6. Acknowledgements (No Responses)

Other members may only acknowledge a report (read receipt). There is no reply,
no commentary, and no ability to request changes. This preserves personal
autonomy and avoids implicit pressure.

6.1 RPCs (implemented)
- preference_responses_submit(answers jsonb)
  - Requires all preference IDs in one submission.
  - Values must be integers 0..2.
- preference_reports_generate(template_key text, locale text, force boolean)
  - Generates or regenerates a report; publishes immediately.
  - Accepts locale as base (en/es/ar) or region (en-NZ); normalizes to base.
  - Preserves edited published content unless force or status=out_of_date.
- preference_reports_edit_section_text(template_key text, locale text, section_key text, new_text text, change_summary text?)
  - Subject-only; edits one section's text and records a revision.
- preference_reports_get_for_home(home_id uuid, subject_user_id uuid, template_key text, locale text)
  - Member-only; returns published report if subject is a current member.
- preference_reports_list_for_home(home_id uuid, template_key text, locale text)
  - Member-only; lists published reports for current members.
- preference_reports_acknowledge(report_id uuid)
  - Member-only; only if viewer shares a current home with subject.
- preference_templates_get_for_user(template_key text)
  - Member-only; returns best template for user locale with fallback.

6.2 Versioning & Growth Tracking

Tracking edits over time is important to show evolution and maintain trust.
Minimum recommended fields:
- Template key and locale used for generation.
- Generated vs published timestamps.
- Revision history with editor id + timestamp.

7. Storage Model (Supabase)

Tables (as implemented)

preference_taxonomy
- preference_id (text, PK)
- is_active (boolean)
- created_at (timestamptz)

preference_taxonomy_defs
- preference_id (text, PK, FK preference_taxonomy)
- domain (text)
- label (text)
- description (text)
- value_keys (text[3])           // maps to option_index 0..2
- aggregation (text)
- safety_notes (text[])
- created_at (timestamptz)
- updated_at (timestamptz)

preference_taxonomy_active_defs (view)
- active join of taxonomy + defs for discovery

preference_responses are user-scoped and portable across homes. Home-specific
outputs are derived by joining current home members to their responses.

preference_responses
- user_id (uuid, PK part)
- preference_id (text, PK part)  // taxonomy id
- option_index (int2)            // 0..2
- captured_at (timestamptz)

preference_report_templates
- id (uuid)
- template_key (text)            // stable template id used by clients
- locale (text)                  // e.g. en
- body (jsonb)                   // sections + per-answer mappings
- created_at (timestamptz)
- updated_at (timestamptz)
- notes: write access via privileged service role only (dashboard).

preference_reports (global per subject/template/locale)
- id (uuid)
- subject_user_id (uuid)
- template_key (text)
- locale (text)                  // e.g. en
- status (text)                  // published|out_of_date
- generated_content (jsonb)      // original generated structure
- published_content (jsonb)      // current visible structure
- generated_at (timestamptz)
- published_at (timestamptz)
- last_edited_at (timestamptz|null)
- last_edited_by (uuid|null)

preference_report_revisions
- id (uuid)
- report_id (uuid)
- editor_user_id (uuid)
- edited_at (timestamptz)
- content (jsonb)
- change_summary (text|null)

preference_report_acknowledgements
- id (uuid)
- report_id (uuid)
- viewer_user_id (uuid)
- acknowledged_at (timestamptz)

RLS (implemented)
- All tables locked down (RPC-only; direct DML revoked).

8. Interpretation & Safety
- Reports must follow the scenario contract's approved phrasing patterns.
- Reports must avoid turning preferences into obligations.
- Aggregated outputs (Home Vibe) must not show single-user preferences when
  member count < 3.

When member count < 3, Home Vibe should include a light disclaimer such as
"early signals" or "based on limited inputs."

Template location and localization
- Templates should be stored in Supabase so copy can evolve without app releases.
- Each template is localized by `locale` (`^[a-z]{2}$`) and keyed by `template_key`.
- `preference_templates_get_for_user` resolves base locale and falls back to `en`.
- Flutter can ship a fallback default template for offline/read-only rendering.
- UI chrome still uses `S.of(context)`; report text is template-driven.

Template mapping requirements
- Templates must include variants for each scenario option (3 per preference).
- Template preference keys must match active preference taxonomy IDs.
- Each option is an object: `{ value_key, title, text }`.
- `value_key` must match `preference_taxonomy_defs.value_keys` by index order.
- Generated content selects the correct variant per user's response.
- Summary is an object `{ title, subtitle }`.
- Sections are `{ section_key, title, text }`.

```contracts-json
{
  "domain": "preference_reports",
  "version": "v1",
  "entities": {
    "PreferenceTaxonomy": {
      "preferenceId": "text",
      "isActive": "boolean",
      "createdAt": "timestamptz"
    },
    "PreferenceTaxonomyDef": {
      "preferenceId": "text",
      "domain": "text",
      "label": "text",
      "description": "text",
      "valueKeys": "text[3]",
      "aggregation": "text",
      "safetyNotes": "text[]",
      "createdAt": "timestamptz",
      "updatedAt": "timestamptz"
    },
    "PreferenceResponse": {
      "userId": "uuid",
      "preferenceId": "text",
      "optionIndex": "int2",
      "capturedAt": "timestamptz"
    },
    "PreferenceReport": {
      "id": "uuid",
      "subjectUserId": "uuid",
      "templateKey": "text",
      "locale": "text",
      "status": "text",
      "generatedContent": "jsonb",
      "publishedContent": "jsonb",
      "generatedAt": "timestamptz",
      "publishedAt": "timestamptz",
      "lastEditedAt": "timestamptz|null",
      "lastEditedBy": "uuid|null"
    },
    "PreferenceReportRevision": {
      "id": "uuid",
      "reportId": "uuid",
      "editorUserId": "uuid",
      "editedAt": "timestamptz",
      "content": "jsonb",
      "changeSummary": "text|null"
    },
    "PreferenceReportTemplate": {
      "id": "uuid",
      "templateKey": "text",
      "locale": "text",
      "body": "jsonb",
      "createdAt": "timestamptz",
      "updatedAt": "timestamptz"
    },
    "PreferenceReportAcknowledgement": {
      "id": "uuid",
      "reportId": "uuid",
      "viewerUserId": "uuid",
      "acknowledgedAt": "timestamptz"
    }
  },
  "functions": {
    "preference.responses.submit": {
      "type": "rpc",
      "caller": "authenticated",
      "impl": "public.preference_responses_submit",
      "args": { "p_answers": "jsonb" },
      "returns": "jsonb"
    },
    "preference.reports.generate": {
      "type": "rpc",
      "caller": "authenticated",
      "impl": "public.preference_reports_generate",
      "args": {
        "p_template_key": "text",
        "p_locale": "text",
        "p_force": "boolean"
      },
      "returns": "jsonb"
    },
    "preference.reports.editSectionText": {
      "type": "rpc",
      "caller": "subject-only",
      "impl": "public.preference_reports_edit_section_text",
      "args": {
        "p_template_key": "text",
        "p_locale": "text",
        "p_section_key": "text",
        "p_new_text": "text",
        "p_change_summary": "text|null"
      },
      "returns": "jsonb"
    },
    "preference.reports.getForHome": {
      "type": "rpc",
      "caller": "member",
      "impl": "public.preference_reports_get_for_home",
      "args": {
        "p_home_id": "uuid",
        "p_subject_user_id": "uuid",
        "p_template_key": "text",
        "p_locale": "text"
      },
      "returns": "jsonb"
    },
    "preference.reports.listForHome": {
      "type": "rpc",
      "caller": "member",
      "impl": "public.preference_reports_list_for_home",
      "args": {
        "p_home_id": "uuid",
        "p_template_key": "text",
        "p_locale": "text"
      },
      "returns": "jsonb"
    },
    "preference.reports.acknowledge": {
      "type": "rpc",
      "caller": "member",
      "impl": "public.preference_reports_acknowledge",
      "args": { "p_report_id": "uuid" },
      "returns": "jsonb"
    },
    "preference.templates.getForUser": {
      "type": "rpc",
      "caller": "authenticated",
      "impl": "public.preference_templates_get_for_user",
      "args": { "p_template_key": "text" },
      "returns": "jsonb"
    }
  },
  "rls": []
}
```